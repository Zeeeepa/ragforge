# Session de debug - 30 d√©cembre 2025, 13h58

## Probl√®me principal: R√©g√©n√©ration inutile des embeddings lors de la r√©-ingestion

### Sympt√¥me
Lors de la modification d'un fichier (m√™me un seul scope), TOUS les embeddings du fichier sont r√©g√©n√©r√©s au lieu de seulement ceux qui ont chang√©. Les logs montrent `old=null` pour tous les embeddings.

### Cause identifi√©e
Le flux de r√©-ingestion ne pr√©serve pas correctement les embedding hashes lors du MERGE des nodes.

### Tentatives de fix

#### 1. Pr√©servation des UUIDs (partiellement r√©solu)
- **Fichier**: `packages/core/src/runtime/adapters/code-source-adapter.ts`
- Le `generateUUID()` utilise maintenant `existingUUIDMapping` pour r√©utiliser les UUIDs existants
- Les logs montrent `[UUID] Reusing existing UUID for ...` - cette partie fonctionne

#### 2. Pr√©servation des embeddings dans `ingestNodes()`
- **Fichier**: `packages/core/src/runtime/adapters/incremental-ingestion.ts`
- Approche en 3 √©tapes ajout√©e (lignes ~660-730):
  1. Query des embeddings existants AVANT le MERGE
  2. MERGE des nodes avec les nouvelles props
  3. Restauration des embeddings apr√®s le MERGE

#### 3. Probl√®me persistant
Les logs de debug montrent:
```
üîí Captured 0 existing embeddings for Scope (38 uuids queried)
‚ö†Ô∏è No embeddings to restore for Scope (38 nodes)
```

**Hypoth√®se**: Les UUIDs g√©n√©r√©s lors du parsing ne correspondent pas √† ceux en base de donn√©es. Cela sugg√®re que `existingUUIDMapping` n'est pas correctement charg√©/utilis√© dans le flux du file watcher.

### Flux concern√©s

1. **`mark_file_dirty` + `queue_for_ingestion`** ‚Üí `reIngestFiles`
   - Ce flux charge `existingUUIDMapping` dans `reIngestFiles` AVANT la suppression
   - Semble mieux fonctionner (logs "Captured 142 unique symbols")

2. **File watcher** ‚Üí `ingestFromPaths` ‚Üí `ingestIncremental` ‚Üí `ingestNodes`
   - Ce flux charge `existingUUIDMapping` dans `ingestFromPaths`
   - Mais les logs 14:08 ne montrent pas le message "Loaded ... symbols"
   - Possible que le mapping ne soit pas correctement pass√© √† l'adapter

### Fichiers modifi√©s

1. `packages/core/src/runtime/adapters/incremental-ingestion.ts`
   - Ajout query embeddings avant MERGE (~ligne 662-685)
   - Ajout restauration apr√®s MERGE (~ligne 710-728)
   - Ajout logging de debug

2. `packages/core/src/runtime/adapters/code-source-adapter.ts`
   - `generateUUID()` v√©rifie `existingUUIDMapping` en priorit√©
   - Instance variable `existingUUIDMapping` ajout√©e

3. `packages/core/src/brain/embedding-service.ts`
   - Logique de hash comparison modifi√©e (priorit√© au hash vs embeddingsDirty flag)
   - Logs de debug ajout√©s

### Prochaines √©tapes sugg√©r√©es

1. V√©rifier pourquoi `existingUUIDMapping` n'est pas charg√© dans le flux file watcher
2. Ajouter plus de logging dans `ingestFromPaths` pour tracer le flux
3. V√©rifier si les UUIDs g√©n√©r√©s matchent bien ceux en DB
4. Possiblement unifier les flux `reIngestFiles` et le flux file watcher

### Note
Ce probl√®me bloque la possibilit√© de marquer tous les fichiers dirty pour appliquer un fix de parser sans r√©g√©n√©rer tous les embeddings (ce qui co√ªte cher en API Gemini).

---

## Solution temporaire: Provider Ollama

Suite aux probl√®mes de paiement Gemini, un provider Ollama a √©t√© impl√©ment√© pour les embeddings locaux.

### Fichiers cr√©√©s/modifi√©s

1. **`packages/core/src/runtime/embedding/ollama-embedding-provider.ts`** (NEW)
   - Provider Ollama avec API locale
   - Health check pour v√©rifier si Ollama est disponible
   - Supporte `nomic-embed-text`, `mxbai-embed-large`, `all-minilm`

2. **`packages/core/src/runtime/embedding/embedding-provider.ts`**
   - Ajout interface `EmbeddingProviderInterface`

3. **`packages/core/src/runtime/embedding/index.ts`** (NEW)
   - Export de tous les providers

4. **`packages/core/src/brain/embedding-service.ts`**
   - Constructor accepte maintenant `EmbeddingProviderConfig` ou API key string
   - Nouvelles m√©thodes: `setProvider()`, `getProviderInfo()`

5. **`packages/core/src/brain/brain-manager.ts`**
   - Config `embeddings.provider` accepte `'gemini' | 'openai' | 'ollama'`
   - Nouvelle config `embeddings.ollama` pour les options Ollama
   - M√©thode `switchEmbeddingProvider()` pour changer √† runtime
   - `buildEmbeddingProviderConfig()` pour construire la config

6. **`packages/core/src/tools/brain-tools.ts`**
   - Nouvel outil `switch_embedding_provider` pour changer de provider
   - `get_brain_status` affiche maintenant le provider actif

### Utilisation

```bash
# Installer un mod√®le Ollama
ollama pull nomic-embed-text

# Utiliser l'outil MCP
switch_embedding_provider({ provider: "ollama" })
switch_embedding_provider({ provider: "ollama", model: "mxbai-embed-large" })
switch_embedding_provider({ provider: "gemini" })
```

### Limitations
- Ollama g√©n√®re des embeddings de dimension 768-1024 vs 3072 pour Gemini
- La recherche s√©mantique existante utilise des embeddings Gemini, il faudra re-g√©n√©rer les embeddings si on switch
