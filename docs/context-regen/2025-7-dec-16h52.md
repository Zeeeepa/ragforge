# Session 7 décembre 2025 - 16h52

## Résumé de la session

Cette session a porté sur l'**implémentation des outils manquants pour l'agent autonome** et la **conception d'une architecture en sections d'outils**.

---

## Ce qui a été implémenté

### 1. Outils File System (`fs-helpers.ts` + `fs-tools.ts`)

**Helpers** (`packages/core/src/tools/fs-helpers.ts`):
- `listDirectory()` - Liste un répertoire avec stats
- `globFiles()` - Recherche par pattern glob
- `pathExists()` - Vérifie existence
- `getFileInfo()` - Métadonnées fichier
- `deletePath()` - Supprime fichier ou répertoire
- `moveFile()` - Déplace/renomme
- `copyFile()` - Copie
- `createDirectory()` - Crée répertoire (mkdir -p)

**Outils agent** (`packages/core/src/tools/fs-tools.ts`):
- `list_directory` - Avec options `recursive`, `show_hidden`, `no_default_excludes`
- `glob_files` - Avec options `ignore`, `no_default_excludes`
- `file_exists`
- `get_file_info`
- `delete_path` - Avec option `recursive`
- `move_file`
- `copy_file`
- `create_directory`

**Option importante**: `no_default_excludes: true` permet d'explorer `node_modules`, `.git`, `dist`, etc.

### 2. Outils Shell (`shell-helpers.ts` + `shell-tools.ts`)

**Helpers** (`packages/core/src/tools/shell-helpers.ts`):
- `SAFE_COMMANDS` - Whitelist de commandes autorisées
- `DANGEROUS_PATTERNS` - Regex pour bloquer les commandes dangereuses
- `CONFIRMATION_REQUIRED` - Commandes nécessitant confirmation
- `validateCommand()` - Valide une commande
- `executeCommand()` - Exécute async
- `executeCommandSync()` - Exécute sync

**Whitelist inclut**:
- Package managers: npm, yarn, pnpm, bun
- Git: status, diff, log, add, commit (PAS push --force, reset --hard)
- File inspection: ls, cat, head, tail, grep, find
- Build tools: tsc, node, npx, python, cargo, go
- Linters: eslint, prettier, biome, rustfmt
- Test runners: jest, vitest, pytest, playwright

**Outils agent** (`packages/core/src/tools/shell-tools.ts`):
- `run_command` - Exécute une commande (avec validation whitelist)
- `run_npm_script` - Raccourci npm run
- `git_status` - État git structuré
- `git_diff` - Diff avec options staged/file
- `list_safe_commands` - Liste les commandes autorisées

### 3. Outils Context (`context-tools.ts`)

**Outils agent** (`packages/core/src/tools/context-tools.ts`):
- `get_working_directory` - cwd, project_root, project_loaded, neo4j_connected
- `get_environment_info` - Node version, OS, available tools (git, docker, python)
- `get_project_info` - package.json, ragforge config, git info, file counts

### 4. Intégration dans `rag-agent.ts`

Les nouveaux outils sont **activés par défaut**:

```typescript
// Dans RagAgentOptions
includeFsTools?: boolean;       // default: true
includeShellTools?: boolean;    // default: true
includeContextTools?: boolean;  // default: true
onShellConfirmation?: (command: string, reason: string) => Promise<boolean>;
```

---

## Architecture en sections d'outils ✅ IMPLÉMENTÉ

### Problème identifié

L'agent a maintenant beaucoup d'outils (~30+), ce qui peut surcharger le contexte LLM.

### Solution proposée

Organiser les outils en **sections** et utiliser une architecture **coordinateur + sous-agents**:

```
┌─────────────────────────────────────────────────────────────┐
│                    AGENT PRINCIPAL                           │
│  Outils: list_tool_sections, plan_actions (étendu),         │
│          get_working_directory, get_project_info            │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   SECTIONS D'OUTILS                          │
├─────────────────────────────────────────────────────────────┤
│  file_ops     │ read_file, write_file, edit_file,           │
│               │ list_directory, glob_files, delete_path...  │
│  shell_ops    │ run_command, run_npm_script, git_status...  │
│  rag_ops      │ query_entities, semantic_search, brain_search│
│  project_ops  │ create_project, setup_project, load_project │
│  web_ops      │ fetch_web_page, ingest_web_page, search_web │
│  media_ops    │ generate_image, render_3d_asset...          │
└─────────────────────────────────────────────────────────────┘
```

### Extension de `plan_actions`

```typescript
plan_actions({
  goal: "Add authentication and test it",
  sections: ["file_ops", "rag_ops", "shell_ops"],  // ← NOUVEAU
  actions: [...]
})
```

### Règles pour sous-agents

1. Reçoivent tous les outils des sections demandées
2. Ont toujours `list_tool_sections` (read-only)
3. Ont `plan_actions` uniquement si `depth < max_depth` (ex: max_depth=3)
4. Ont toujours les context tools de base

### `list_tool_sections` tool

```typescript
// Retourne:
{
  sections: [
    {
      id: "file_ops",
      description: "Read, write, edit, list files",
      tools: ["read_file", "write_file", "edit_file", "list_directory", ...]
    },
    {
      id: "shell_ops",
      description: "Run commands, git, npm",
      tools: ["run_command", "git_status", ...]
    },
    ...
  ]
}
```

---

## Fichiers créés/modifiés

### Créés
- `packages/core/src/tools/fs-helpers.ts`
- `packages/core/src/tools/fs-tools.ts`
- `packages/core/src/tools/shell-helpers.ts`
- `packages/core/src/tools/shell-tools.ts`
- `packages/core/src/tools/context-tools.ts`

### Modifiés
- `packages/core/src/index.ts` - Exports
- `packages/core/src/runtime/agents/rag-agent.ts` - Intégration (sections 3f, 3g, 3h)
- `docs/project/AGENT-MISSING-TOOLS.md` - Mis à jour avec status ✅

---

## Tool Sections - IMPLÉMENTÉ (Session 17h+)

### Fichiers créés

- `packages/core/src/tools/tool-sections.ts`
- Ajout `section` à TOUS les outils existants

### Implémentation

1. **Type `ToolSection`** dans `types/index.ts`:
   ```typescript
   export type ToolSection =
     | 'file_ops' | 'shell_ops' | 'rag_ops' | 'project_ops'
     | 'web_ops' | 'media_ops' | 'context_ops' | 'planning_ops';
   ```

2. **`SECTION_INFO`** - Record<ToolSection, SectionInfo> force la compilation à échouer si une section n'est pas décrite

3. **Utilitaires**:
   - `aggregateToolsBySection(tools)` - Groupe les outils par section
   - `getToolsForSections(tools, sections)` - Filtre par sections
   - `getSectionSummary(tools)` - Résumé avec counts et noms d'outils
   - `validateSections(sectionIds)` - Validation des IDs
   - `SubAgentContext` + helpers pour tracking profondeur

4. **Chaque outil a maintenant `section`**:
   ```typescript
   return {
     name: 'read_file',
     section: 'file_ops',  // ← NOUVEAU
     description: '...',
     inputSchema: {...}
   };
   ```

---

## Prochaines étapes - MCP Integration

### Phase 1 : MCP Server (Exposer RagForge)

Permettre à Claude Code de se connecter à RagForge via MCP.

```bash
ragforge mcp-server [--project <path>]
```

Fichiers à créer:
- `packages/cli/src/mcp/tool-adapter.ts` - Convertit GeneratedToolDefinition → MCP Tool
- `packages/cli/src/mcp/server.ts` - Serveur MCP stdio

### Phase 2 : MCP Client (Se connecter à d'autres serveurs)

Nouveaux outils section `mcp_ops`:
- `connect_mcp_server` - Connecter à un serveur
- `list_mcp_tools` - Lister les outils disponibles
- `call_mcp_tool` - Appeler un outil
- `disconnect_mcp_server` - Déconnecter

Fichiers à créer:
- `packages/core/src/mcp/client-manager.ts` - Gestionnaire de connexions
- `packages/core/src/tools/mcp-client-tools.ts` - Outils agent

Voir `docs/project/7-dec-11h29-2025/MCP-INTEGRATION.md` pour les détails.

---

## Notes techniques

### Default excludes pour FS tools
```typescript
const DEFAULT_EXCLUDES = [
  'node_modules', '.git', 'dist', '__pycache__',
  'build', '.next', '.nuxt', 'coverage'
];
```

### Commandes dangereuses bloquées
```typescript
const DANGEROUS_PATTERNS = [
  /\brm\s+(-[rf]+\s+)*[\/~]/,    // rm with paths
  /\bgit\s+push\s+.*--force/,    // git push --force
  /\bgit\s+reset\s+--hard/,      // git reset --hard
  /\bsudo\b/,                     // sudo
  /curl.*\|.*sh/,                // curl | sh
  // ...
];
```

### Commandes nécessitant confirmation
```typescript
const CONFIRMATION_REQUIRED = [
  /\bgit\s+push\b/,    // Any git push
  /\brm\s/,            // Any rm
  /\bmv\s/,            // Any mv
  // ...
];
```
